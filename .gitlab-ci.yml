stages:
  - cleanup_stage
  - backendtry
  - frontendtry

cleanup:
  stage: cleanup_stage
  only:
    refs:
      - main
    changes:
      - backend/*
      - frontend/*
  variables:
    GIT_STRATEGY: none
  tags:
    - node
  script:
    - sudo rm -rf *
    - sudo rm -rf .git
    - cd ~
    - sudo chown -R gitlab-runner builds/

backend-build:
  stage: backendtry
  only:
    refs:
      - main
    changes:
      - backend/*
      - frontend/*
  tags:
    - node
  script:
    - pm2 status
    - cd backend
    - npm install
    - pm2 delete "server_backend" 2> /dev/null || true
    - pm2 start npm --name "server_backend" -- run start

frontend-build:
  stage: frontendtry
  variables: 
    GIT_STRATEGY: clone
  only:
    refs:
      - main
    changes:
      - backend/*
      - frontend/*
  tags:
    - vue
  script:
    - pm2 status
    - cd frontend
    - npm set-script prepare ''
    - sudo npm install
    - sudo npm run build
    - pm2 delete "server_frontend" 2> /dev/null || true
    - pm2 start
