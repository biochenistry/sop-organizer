stages:
  - cleanup_stage
  - backendtry
  - frontendtry

cleanup:
  stage: cleanup_stage
  only:
    refs:
      - main
    changes:
      - backend/*
      - frontend/*
  variables:
    GIT_STRATEGY: none
  tags:
    - node
  script:
    - pm2 delete "server_backend" 2> /dev/null || true
    - pm2 delete "server_frontend" 2> /dev/null || true
    - sudo rm -rf /home/gitlab-runner/builds/*
    - sudo chown -R gitlab-runner /home/gitlab-runner/builds/

backend-build:
  stage: backendtry
  only:
    refs:
      - main
    changes:
      - backend/*
      - frontend/*
  tags:
    - node
  before_script:
    - cp /home/sop/sop-organizer-2/backend/.env ./backend
    - cp /home/sop/sop-organizer-2/frontend/.env ./frontend
  script:
    - ls
    - pm2 status
    - cd backend
    - npm install
    - pm2 start npm --name "server_backend" -- run start

frontend-build:
  stage: frontendtry
  variables: 
    GIT_STRATEGY: clone
  only:
    refs:
      - main
    changes:
      - backend/*
      - frontend/*
  tags:
    - vue
  before_script:
    - sudo chown -R gitlab-runner /home/gitlab-runner/builds/
    - cp /home/sop/sop-organizer-2/backend/.env ./backend
    - cp /home/sop/sop-organizer-2/frontend/.env ./frontend
  script:
    - pm2 status
    - cd frontend
    - npm set-script prepare ''
    - sudo npm install
    - sudo npm run build
    - pm2 start
